substitutions:
  name: "rfid-scan-http"

esphome:
  name: ${name}

esp32:
  board: esp32dev
  framework:
    type: arduino

logger:
  level: DEBUG

wifi:
  ssid: !secret ssid
  password: !secret wifi_password

<<<<<<< HEAD
# HTTP Request Komponente statt MQTT
http_request:
  verify_ssl: false  # Auf true setzen wenn du ein gÃ¼ltiges SSL-Zertifikat hast
  timeout: 10s
=======
mqtt:
  broker: !secret mqtt_broker
  port: 1883
  on_message:
    - topic: display/message
      then:
        - globals.set:
            id: display_message
            value: !lambda |-
              return x;
>>>>>>> 28b28d1 (feat: new display)

spi:
  clk_pin: GPIO18  # SCK
  miso_pin: GPIO19  # MISO
  mosi_pin: GPIO23  # MOSI

<<<<<<< HEAD
rc522_spi:
  cs_pin: GPIO22
=======
i2c:
  sda: GPIO21  # Display SDA
  scl: GPIO22  # Display SCL
  scan: true

rc522_spi:
  cs_pin: GPIO5
>>>>>>> 28b28d1 (feat: new display)
  update_interval: 1s
  reset_pin: GPIO2

  on_tag:
    then:
<<<<<<< HEAD
      - logger.log:
          format: "RFID Tag detected: %s"
          args: ['x.c_str()']
      - http_request.post:
          url: https://vm12.htl-leonding.ac.at/api/RfidChips/scan
          headers:
            Content-Type: application/json
          json:
            chipId: !lambda |-
              std::string tag = x;
              tag.erase(std::remove(tag.begin(), tag.end(), '-'), tag.end());
              return tag;
            event: "scan"
          on_response:
            then:
              - logger.log:
                  format: "Response: %d"
                  args: ['status_code']
  
  on_tag_removed:
    then:
      - logger.log:
          format: "RFID Tag removed: %s"
          args: ['x.c_str()']
      - http_request.post:
          url: https://vm12.htl-leonding.ac.at/api/RfidChips/scan
          headers:
            Content-Type: application/json
          json:
            chipId: !lambda |-
              std::string tag = x;
              tag.erase(std::remove(tag.begin(), tag.end(), '-'), tag.end());
              return tag;
            event: "removed"
          on_response:
            then:
              - logger.log:
                  format: "Response: %d"
                  args: ['status_code']
=======
      - globals.set:
          id: last_rfid_tag
          value: !lambda |-
            std::string tag = x;
            tag.erase(std::remove(tag.begin(), tag.end(), '-'), tag.end());
            return tag;
      - mqtt.publish:
          topic: rc522/tag
          payload: !lambda |-
            std::string tag = x;
            tag.erase(std::remove(tag.begin(), tag.end(), '-'), tag.end());
            return tag;
  on_tag_removed:
    then:
      - globals.set:
          id: last_rfid_tag
          value: '""'
      - mqtt.publish:
          topic: rc522/tag_removed
          payload: !lambda |-
            std::string tag = x;
            tag.erase(std::remove(tag.begin(), tag.end(), '-'), tag.end());
            return tag;
>>>>>>> 28b28d1 (feat: new display)


display:
  - platform: ssd1306_i2c
    model: "SSD1306 128x64"
    address: 0x3C
    update_interval: 0.5s
    lambda: |-
      it.print(0, 0, id(font1), "RFID Scanner");
      it.printf(0, 16, id(font1), "%s", id(display_message).c_str());
      if (id(last_rfid_tag) != "") {
        it.printf(0, 32, id(font1), "Tag: %.8s", id(last_rfid_tag).c_str());
      }

font:
  - file: "gfonts://Roboto"
    id: font1
    size: 12

globals:
  - id: last_rfid_tag
    type: std::string
    restore_value: no
    initial_value: '""'
  - id: display_message
    type: std::string
    restore_value: no
    initial_value: '"Ready..."'

binary_sensor:
  - platform: rc522
    uid: 74-10-37-94
    name: "RC522 RFID Tag"

