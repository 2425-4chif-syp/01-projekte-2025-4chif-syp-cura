<header>
  <h1>CURA</h1>
  <div class="user-info">
    <div class="user-line">
      <i class="fa-solid fa-user"></i>
      <span class="user-name">{{ userName }}</span>
    </div>
    <div class="date-line">
      <span class="user-date">{{ currentDate }}</span>
      <button (click)="logout()" class="btn-logout" title="Abmelden">
        <i class="fa-solid fa-right-from-bracket"></i>
      </button>
    </div>
  </div>
</header>

<main>
  <div class="main-layout">
    <!-- Left Column: Kalender und Einnahmequote -->
    <div class="left-column">
      <aside class="calendar-card" [class.flipped]="showDayDetail">
        <div class="calendar-inner">
          <!-- Calendar Front -->
          <div class="calendar-front">
            <h2>{{ currentMonth }}</h2>
            <div class="weekdays">
              <span>Mo</span>
              <span>Di</span>
              <span>Mi</span>
              <span>Do</span>
              <span>Fr</span>
              <span>Sa</span>
              <span>So</span>
            </div>
            <div class="calendar-grid">
              @for (day of calendarDays; track day.date) {
                <div class="day" 
                     [class.checked]="day.checked" 
                     [class.partial]="day.partial" 
                     [class.missed]="day.missed" 
                     [class.no-data]="!day.checked && !day.partial && !day.missed && day.day > 0"
                     (click)="openDayDetail(day)">
                  @if (day.day > 0) {
                    <span>{{ day.day }}</span>
                  }
                </div>
              }
            </div>
          </div>
          
          <!-- Day Detail Back -->
          <div class="calendar-back">
            <div class="day-detail-header">
              <h2>{{ selectedDay ? getFormattedDate(selectedDay.date) : '' }}</h2>
              <button class="btn-close" (click)="closeDayDetail()">
                <i class="fa-solid fa-xmark"></i>
              </button>
            </div>
            
            <div class="day-detail-content">
              @if (groupedMedications.length === 0) {
                <p class="no-medications">Keine Medikamente für diesen Tag geplant</p>
              } @else {
                <!-- Desktop: Accordion View -->
                <div class="desktop-time-groups">
                  @for (timeGroup of groupedMedications; track timeGroup.timeLabel) {
                    <div class="time-group" 
                         [class.all-taken]="timeGroup.allTaken" 
                         [class.has-missed]="!timeGroup.allTaken"
                         [class.expanded]="isTimeGroupExpanded(timeGroup.timeLabel)">
                      <div class="time-group-header" (click)="toggleTimeGroup(timeGroup.timeLabel)">
                        <i class="fa-solid fa-clock"></i>
                        <span>{{ timeGroup.timeLabel }}</span>
                        <i class="fa-solid toggle-icon" 
                           [class.fa-chevron-down]="!isTimeGroupExpanded(timeGroup.timeLabel)"
                           [class.fa-chevron-up]="isTimeGroupExpanded(timeGroup.timeLabel)"></i>
                      </div>
                      @if (isTimeGroupExpanded(timeGroup.timeLabel)) {
                        <div class="medication-list">
                          @for (med of timeGroup.medications; track $index) {
                            <div class="medication-name" [class.taken]="med.status === 'taken'" [class.missed]="med.status === 'missed'">
                              {{ med.name }}
                            </div>
                          }
                        </div>
                      }
                    </div>
                  }
                </div>
                
                <!-- Mobile: Carousel View -->
                <div class="mobile-time-carousel"
                     (touchstart)="onTouchStart($event)"
                     (touchend)="onTouchEnd($event)">
                  @if (groupedMedications[currentTimeIndex]; as currentGroup) {
                    <div class="time-slide">
                      <div class="time-group-mobile" 
                           [class.all-taken]="currentGroup.allTaken" 
                           [class.has-missed]="!currentGroup.allTaken">
                        <div class="time-group-header-mobile">
                          <i class="fa-solid fa-clock"></i>
                          <span>{{ currentGroup.timeLabel }}</span>
                        </div>
                        <div class="medication-list-mobile">
                          @for (med of currentGroup.medications; track $index) {
                            <div class="medication-name" [class.taken]="med.status === 'taken'" [class.missed]="med.status === 'missed'">
                              {{ med.name }}
                            </div>
                          }
                        </div>
                      </div>
                    </div>
                  }
                </div>
                
                <!-- Carousel Dots Navigation (at bottom of calendar) -->
                @if (groupedMedications.length > 1) {
                  <div class="carousel-dots">
                    @for (group of groupedMedications; track $index) {
                      <button class="dot" 
                              [class.active]="$index === currentTimeIndex"
                              [class.has-missed]="!group.allTaken"
                              (click)="goToTimeGroup($index)"
                              [attr.aria-label]="'Zu ' + group.timeLabel + ' wechseln'">
                      </button>
                    }
                  </div>
                }
              }
            </div>
          </div>
        </div>
      </aside>

      <div class="income-quote">
        <h3>Einnahme quote {{ currentMonth }}</h3>

        <div class="progress-bar">
          <div class="progress-segment checked" [style.width.%]="checkedPercentage"></div>
          <div class="progress-segment partial" [style.width.%]="partialPercentage"></div>
          <div class="progress-segment missed" [style.width.%]="missedPercentage"></div>
        </div>
        <p></p>
        <div class="status-labels">
          <span class="status-label">
            <span class="status-dot checked"></span> Eingenommen: {{ checkedPercentage }}%
          </span>
          <!--<span class="status-label">
            <span class="status-dot partial"></span> Teilweise: {{ partialPercentage }}%
          </span> -->
          <span class="status-label">
            <span class="status-dot missed"></span> Verpasst: {{ missedPercentage }}%
          </span>
        </div>
      </div>
    </div>

    <!-- Medikamentenplan - Desktop Version (alle Tage) -->
    <section class="medication-card desktop-medication" [class.flipped]="showPlanSelection">
      <div class="medication-inner">
        <!-- Front: Medikamentenplan -->
        <div class="medication-front">
          <h2>{{ availablePlans.find(p => p.id === selectedPlanId)?.name || 'Medikamentenplan' }}</h2>
          <table class="medication-table">
            <thead>
              <tr>
                <th class="time-label"></th>
                <th>Mo</th>
                <th>Di</th>
                <th>Mi</th>
                <th>Do</th>
                <th>Fr</th>
                <th>Sa</th>
                <th>So</th>
              </tr>
            </thead>
            <tbody>
              @for (row of medicationRows; track $index) {
                <tr>
                  <td class="time-label">{{ row.timeLabel }}</td>
                  @for (cell of row.days; track $index) {
                    <td>{{ cell }}</td>
                  }
                </tr>
              }
            </tbody>
          </table>
          <div class="action-buttons">
            <button class="btn-primary" (click)="openPlanSelection()">ändern</button>
            <button class="btn-secondary" (click)="exportMedicationPlan()">exportieren</button>
          </div>
        </div>
        
        <!-- Back: Plan-Auswahl -->
        <div class="medication-back">
          <div class="plan-selection-header">
            <h2>Medikamentenplan wählen</h2>
            <button class="btn-close" (click)="closePlanSelection()">
              <i class="fa-solid fa-xmark"></i>
            </button>
          </div>
          
          <div class="plan-selection-content">
            @for (plan of availablePlans; track plan.id) {
              <div class="plan-option" 
                   [class.selected]="plan.id === selectedPlanId"
                   (click)="selectPlan(plan.id)">
                <div class="plan-icon">
                  <i class="fa-solid fa-pills"></i>
                </div>
                <div class="plan-info">
                  <h3>{{ plan.name }}</h3>
                  <p>{{ plan.patientName }}</p>
                </div>
                @if (plan.id === selectedPlanId) {
                  <i class="fa-solid fa-check plan-check"></i>
                }
              </div>
            }
          </div>
        </div>
      </div>
    </section>

    <!-- Medikamentenplan - Mobile Version (nur aktueller Tag) -->
    <section class="medication-card mobile-medication" [class.flipped]="showPlanSelection">
      <div class="medication-inner">
        <!-- Front: Medikamentenplan -->
        <div class="medication-front">
          <h2>{{ availablePlans.find(p => p.id === selectedPlanId)?.name || 'Medikamentenplan' }} - {{ currentDayName }}</h2>
          <table class="medication-table">
            <thead>
              <tr>
                <th class="time-label">Uhrzeit</th>
                <th>Medikament</th>
              </tr>
            </thead>
            <tbody>
              @for (row of medicationRows; track $index) {
                <tr>
                  <td class="time-label">{{ row.timeLabel }}</td>
                  <td>{{ row.days[currentDayIndex] }}</td>
                </tr>
              }
            </tbody>
          </table>
          <div class="action-buttons">
            <button class="btn-primary" (click)="openPlanSelection()">ändern</button>
            <button class="btn-secondary" (click)="exportMedicationPlan()">exportieren</button>
          </div>
        </div>
        
        <!-- Back: Plan-Auswahl -->
        <div class="medication-back">
          <div class="plan-selection-header">
            <h2>Plan wählen</h2>
            <button class="btn-close" (click)="closePlanSelection()">
              <i class="fa-solid fa-xmark"></i>
            </button>
          </div>
          
          <div class="plan-selection-content">
            @for (plan of availablePlans; track plan.id) {
              <div class="plan-option" 
                   [class.selected]="plan.id === selectedPlanId"
                   (click)="selectPlan(plan.id)">
                <div class="plan-icon">
                  <i class="fa-solid fa-pills"></i>
                </div>
                <div class="plan-info">
                  <h3>{{ plan.name }}</h3>
                  <p>{{ plan.patientName }}</p>
                </div>
                @if (plan.id === selectedPlanId) {
                  <i class="fa-solid fa-check plan-check"></i>
                }
              </div>
            }
          </div>
        </div>
      </div>
    </section>
  </div>
</main>