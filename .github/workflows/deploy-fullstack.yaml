name: ğŸš€ Deploy Full Stack (Backend + Database)

on:
  push:
    branches:
      - main
    paths:
      - 'database/**'
      - 'backend/**'
  workflow_dispatch:

jobs:
  deploy-full-stack:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy Full Stack via SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VM12_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H vm12.htl-leonding.ac.at >> ~/.ssh/known_hosts
          
          ssh -o StrictHostKeyChecking=no curaadm@vm12.htl-leonding.ac.at << 'EOF'
            echo "ï¿½ Starting full stack deployment (Database + Backend + pgAdmin)..."
            
            cd ~/cura-project
            
            # Fix ownership
            sudo chown -R curaadm:curaadm .
            
            # ğŸ” DEBUG: Show current state before changes
            echo "ğŸ” DEBUG: Current directory: $(pwd)"
            echo "ğŸ” DEBUG: Current user: $(whoami)"
            echo "ğŸ” DEBUG: Git status before pull:"
            git status --porcelain || echo "Git status failed"
            echo "ğŸ” DEBUG: Current git commit:"
            git log --oneline -1 || echo "Git log failed"
            
            # Force pull (Ã¼berschreibt lokale Ã„nderungen)
            echo "ğŸ”„ Resetting git state..."
            git reset --hard HEAD
            git clean -fd
            echo "ğŸ“¥ Pulling latest changes..."
            git pull origin main
            
            # ğŸ” DEBUG: Show state after pull
            echo "ğŸ” DEBUG: Git status after pull:"
            git status --porcelain || echo "Git status failed"
            echo "ğŸ” DEBUG: New git commit:"
            git log --oneline -1 || echo "Git log failed"
            
            cd database
            
            # Docker installieren falls nicht vorhanden
            if ! command -v docker &> /dev/null; then
              echo "ğŸ³ Installing Docker..."
              curl -fsSL https://get.docker.com -o get-docker.sh
              sudo sh get-docker.sh
              sudo usermod -aG docker curaadm
              echo "ğŸ”„ Please log out and back in for Docker group changes to take effect"
            fi
            
            # ğŸ” DEBUG: System information
            echo "ğŸ” DEBUG: System info:"
            echo "  - OS: $(lsb_release -d -s 2>/dev/null || echo 'Unknown')"
            echo "  - Docker version: $(docker --version 2>/dev/null || echo 'Not installed')"
            echo "  - Docker Compose version: $(docker compose version 2>/dev/null || echo 'Not installed')"
            echo "  - Available memory: $(free -h | grep Mem: || echo 'Unknown')"
            echo "  - Available disk: $(df -h . | tail -1 || echo 'Unknown')"
            
            # Ensure we can pull .NET 8 images
            echo "ğŸ“¦ Pre-pulling required Docker images..."
            docker pull mcr.microsoft.com/dotnet/sdk:8.0 || echo "âŒ Failed to pull .NET SDK image"
            docker pull mcr.microsoft.com/dotnet/aspnet:8.0 || echo "âŒ Failed to pull .NET runtime image"
            
            # ğŸ” DEBUG: Show docker images
            echo "ğŸ” DEBUG: Available Docker images:"
            docker images | head -10

            # Docker Compose Plugin sicherstellen
            if ! docker compose version &> /dev/null; then
              echo "ğŸ”§ Installing Docker Compose plugin..."
              sudo apt-get update
              sudo apt-get install -y docker-compose-plugin
            fi
            
            # ğŸ” DEBUG: Show current docker state before changes
            echo "ğŸ” DEBUG: Current Docker containers:"
            docker ps -a || echo "No containers"
            echo "ğŸ” DEBUG: Docker networks:"
            docker network ls || echo "No networks"
            echo "ğŸ” DEBUG: Docker volumes:"
            docker volume ls || echo "No volumes"
            
            # Container starten/neustarten
            echo "ğŸš€ Starting containers (PostgreSQL + pgAdmin + Backend)..."
            echo "â¬‡ï¸ Stopping existing containers..."
            docker compose down || true
            
            # ğŸ”§ NOTE: We do NOT delete volumes to preserve Keycloak realm data!
            # Only delete volume if you explicitly need a fresh database:
            # docker volume rm database_postgres_data
            
            # ğŸ” DEBUG: Show docker-compose.yaml
            echo "ğŸ” DEBUG: Docker Compose configuration:"
            cat docker-compose.yaml | head -20
            echo "... (truncated for brevity)"
            
            echo "ğŸ—ï¸ Building and starting containers..."
            docker compose up -d --build
            
            # â³ Wait for Keycloak to be ready
            echo "â³ Waiting for Keycloak to start (90 seconds)..."
            sleep 90
            
            # ğŸ” Import Keycloak realm if needed
            echo "ğŸ” Checking and importing Keycloak realm..."
            cd ../keycloak-config
            chmod +x import-realm.sh
            ./import-realm.sh || echo "âš ï¸ Keycloak realm import had issues (might already exist)"
            cd ../database
            
            echo "ğŸ“‹ Container status after startup:"
            docker compose ps
            
            # ğŸ” DEBUG: Show detailed container information
            echo "ğŸ” DEBUG: Container details:"
            for container in cura_postgres cura_backend cura_pgadmin; do
              echo "  ğŸ“¦ $container:"
              if docker inspect $container > /dev/null 2>&1; then
                echo "    - Status: $(docker inspect --format='{{.State.Status}}' $container 2>/dev/null || echo 'Unknown')"
                echo "    - Health: $(docker inspect --format='{{.State.Health.Status}}' $container 2>/dev/null || echo 'No health check')"
                echo "    - Restart Count: $(docker inspect --format='{{.RestartCount}}' $container 2>/dev/null || echo 'Unknown')"
              else
                echo "    - Container not found!"
              fi
            done
            
            # Warten bis PostgreSQL ready ist
            echo "â³ Waiting for database (with detailed debugging)..."
            for i in {1..30}; do
              echo "ğŸ” DEBUG: Database check attempt $i/30"
              
              # Check if container is running
              if ! docker compose ps postgres | grep -q "Up"; then
                echo "âŒ PostgreSQL container is not running!"
                docker compose logs postgres | tail -20
                sleep 2
                continue
              fi
              
              # Check if database is ready
              if docker compose exec -T postgres pg_isready > /dev/null 2>&1; then
                echo "âœ… Database is ready!"
                break
              else
                echo "â³ Database not ready yet... (attempt $i/30)"
                if [ $((i % 5)) -eq 0 ]; then
                  echo "ğŸ” DEBUG: PostgreSQL logs (last 10 lines):"
                  docker compose logs postgres | tail -10
                fi
              fi
              sleep 2
            done
            
            echo "âœ… Deployment completed!"
            echo "ğŸ“‹ Final container status:"
            docker compose ps
            
            echo "ï¿½ Services available at:"
            echo "  ğŸš€ Backend API: http://vm12.htl-leonding.ac.at:8081"
            echo "  ğŸ“– Swagger UI: http://vm12.htl-leonding.ac.at:8081/swagger/index.html"
            echo "  ğŸ”§ pgAdmin: http://vm12.htl-leonding.ac.at:8080"
            echo "  ğŸ—„ï¸ PostgreSQL: vm12.htl-leonding.ac.at:5434"
            
            echo "ï¿½ğŸ“Š Database tables:"
            docker compose exec -T postgres psql -U admin -d cura -c "\dt" 2>/dev/null || echo "Database not ready yet"
            
            echo "ğŸ©º Backend health check with detailed debugging:"
            for i in {1..6}; do
              echo "ğŸ” DEBUG: Backend check attempt $i/6"
              
              # Check if backend container is running
              if ! docker compose ps backend | grep -q "Up"; then
                echo "âŒ Backend container is not running!"
                echo "ğŸ” DEBUG: Backend container status:"
                docker compose ps backend
                echo "ğŸ” DEBUG: Backend logs (last 20 lines):"
                docker compose logs backend | tail -20 || echo "No backend logs available"
                sleep 10
                continue
              fi
              
              # Check specific endpoints
              echo "ğŸ” DEBUG: Testing backend endpoints..."
              
              # Test Swagger UI
              if curl -f -s http://localhost:8081/swagger/index.html > /dev/null; then
                echo "âœ… Swagger UI is accessible"
              else
                echo "âŒ Swagger UI not accessible"
              fi
              
              # Test API endpoint
              if curl -f -s http://localhost:8081/api/Medications > /dev/null; then
                echo "âœ… Backend API is healthy!"
                break
              else
                echo "â³ Backend API not ready yet... (attempt $i/6)"
                
                # Show detailed curl response every 2nd attempt
                if [ $((i % 2)) -eq 0 ]; then
                  echo "ğŸ” DEBUG: Detailed curl response:"
                  curl -v http://localhost:8081/api/Medications 2>&1 | head -20 || echo "Curl failed"
                fi
              fi
              
              sleep 10
              
              if [ $i -eq 6 ]; then
                echo "âŒ Backend health check failed! Final debugging:"
                echo "ğŸ” DEBUG: All container statuses:"
                docker compose ps
                echo "ğŸ” DEBUG: Backend logs (last 50 lines):"
                docker compose logs backend | tail -50 || echo "No backend logs available"
                echo "ğŸ” DEBUG: Network connectivity test:"
                docker compose exec -T postgres ping -c 3 backend || echo "Network ping failed"
              fi
            done
            
            # ğŸ” DEBUG: Final system state
            echo "ğŸ” DEBUG: Final deployment state:"
            echo "  ğŸ“Š Container statuses:"
            docker compose ps
            echo "  ğŸ”— Port bindings:"
            docker compose port postgres 5432 2>/dev/null || echo "PostgreSQL port not bound"
            docker compose port backend 8080 2>/dev/null || echo "Backend port not bound"
            docker compose port pgadmin 80 2>/dev/null || echo "pgAdmin port not bound"
            
            echo "ğŸŒ Testing external connectivity..."
            echo "ğŸ” Testing Backend from external:"
            timeout 10 curl -f http://vm12.htl-leonding.ac.at:8081/swagger/index.html && echo "âœ… Backend externally accessible" || echo "âŒ Backend not externally accessible"
            
            echo "ğŸ” Testing Backend from localhost:"
            timeout 10 curl -f http://localhost:8081/swagger/index.html && echo "âœ… Backend locally accessible" || echo "âŒ Backend not locally accessible"
            
            echo "ğŸ” Testing pgAdmin:"
            timeout 10 curl -f http://vm12.htl-leonding.ac.at:8080 && echo "âœ… pgAdmin externally accessible" || echo "âŒ pgAdmin not externally accessible"
            
            echo "ğŸ” Server network info:"
            echo "  - Server IP: $(hostname -I | awk '{print $1}')"
            echo "  - Listening ports: $(ss -tuln | grep -E ':(8081|8080|5434)' || echo 'None found')"
          EOF