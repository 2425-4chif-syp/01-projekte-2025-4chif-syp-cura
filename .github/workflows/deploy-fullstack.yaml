name: ğŸš€ Deploy Full Stack (Backend + Database)

on:
  push:
    branches:
      - main
    paths:
      - 'database/**'
      - 'backend/**'
  workflow_dispatch:

jobs:
  deploy-full-stack:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy Full Stack via SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VM12_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H vm12.htl-leonding.ac.at >> ~/.ssh/known_hosts
          
          ssh -o StrictHostKeyChecking=no \
              -o ServerAliveInterval=30 \
              -o ServerAliveCountMax=10 \
              curaadm@vm12.htl-leonding.ac.at << 'EOF'
            echo "ï¿½ Starting full stack deployment (Database + Backend + pgAdmin)..."
            
            cd ~/cura-project
            
            # Fix ownership
            sudo chown -R curaadm:curaadm .
            
            # ğŸ” DEBUG: Show current state before changes
            echo "ğŸ” DEBUG: Current directory: $(pwd)"
            echo "ğŸ” DEBUG: Current user: $(whoami)"
            echo "ğŸ” DEBUG: Git status before pull:"
            git status --porcelain || echo "Git status failed"
            echo "ğŸ” DEBUG: Current git commit:"
            git log --oneline -1 || echo "Git log failed"
            
            # Force pull (Ã¼berschreibt lokale Ã„nderungen)
            echo "ğŸ”„ Resetting git state..."
            git reset --hard HEAD
            git clean -fd
            echo "ğŸ“¥ Pulling latest changes..."
            git pull origin main
            
            # ğŸ” DEBUG: Show state after pull
            echo "ğŸ” DEBUG: Git status after pull:"
            git status --porcelain || echo "Git status failed"
            echo "ğŸ” DEBUG: New git commit:"
            git log --oneline -1 || echo "Git log failed"
            
            cd database
            
            # Docker installieren falls nicht vorhanden
            if ! command -v docker &> /dev/null; then
              echo "ğŸ³ Installing Docker..."
              curl -fsSL https://get.docker.com -o get-docker.sh
              sudo sh get-docker.sh
              sudo usermod -aG docker curaadm
              echo "ğŸ”„ Please log out and back in for Docker group changes to take effect"
            fi
            
            # ğŸ” DEBUG: System information
            echo "ğŸ” DEBUG: System info:"
            echo "  - OS: $(lsb_release -d -s 2>/dev/null || echo 'Unknown')"
            echo "  - Docker version: $(docker --version 2>/dev/null || echo 'Not installed')"
            echo "  - Docker Compose version: $(docker compose version 2>/dev/null || echo 'Not installed')"
            echo "  - Available memory: $(free -h | grep Mem: || echo 'Unknown')"
            echo "  - Available disk: $(df -h . | tail -1 || echo 'Unknown')"
            
            # Ensure we can pull .NET 8 images
            echo "ğŸ“¦ Pre-pulling required Docker images..."
            docker pull mcr.microsoft.com/dotnet/sdk:8.0 || echo "âŒ Failed to pull .NET SDK image"
            docker pull mcr.microsoft.com/dotnet/aspnet:8.0 || echo "âŒ Failed to pull .NET runtime image"
            
            # ğŸ” DEBUG: Show docker images
            echo "ğŸ” DEBUG: Available Docker images:"
            docker images | head -10

            # Docker Compose Plugin sicherstellen
            if ! docker compose version &> /dev/null; then
              echo "ğŸ”§ Installing Docker Compose plugin..."
              sudo apt-get update
              sudo apt-get install -y docker-compose-plugin
            fi
            
            # ğŸ” DEBUG: Show current docker state before changes
            echo "ğŸ” DEBUG: Current Docker containers:"
            docker ps -a || echo "No containers"
            echo "ğŸ” DEBUG: Docker networks:"
            docker network ls || echo "No networks"
            echo "ğŸ” DEBUG: Docker volumes:"
            docker volume ls || echo "No volumes"
            
            # Container starten/neustarten
            echo "ğŸš€ Starting containers (PostgreSQL + pgAdmin + Backend)..."
            echo "â¬‡ï¸ Stopping existing containers..."
            docker compose down || true
            
            # ğŸ”§ NOTE: We do NOT delete volumes to preserve Keycloak realm data!
            # Only delete volume if you explicitly need a fresh database:
            # docker volume rm database_postgres_data
            
            # ğŸ” DEBUG: Show docker-compose.yaml
            echo "ğŸ” DEBUG: Docker Compose configuration:"
            cat docker-compose.yaml | head -20
            echo "... (truncated for brevity)"
            
            echo "ğŸ—ï¸ Building and starting containers..."
            docker compose up -d --build
            
            echo "ğŸ“‹ Container status after startup:"
            docker compose ps
            echo "ğŸ” DEBUG: Container status check completed (exit code: $?)"
            
            # Warten bis PostgreSQL ready ist (kurz & schnell)
            echo "â³ Waiting for database..."
            echo "ğŸ” DEBUG: Starting database readiness loop..."
            for i in {1..15}; do
              if docker compose exec -T postgres pg_isready > /dev/null 2>&1; then
                echo "âœ… Database is ready!"
                break
              fi
              sleep 1
            done || true
            echo "ğŸ” DEBUG: Database check loop finished (exit code: $?)"
            
            # ğŸ©º Backend health check (PRIORITÃ„T - vor Keycloak!)
            echo "ğŸ” DEBUG: About to start backend health check..."
            echo "ğŸ©º Backend health check:"
            for i in {1..4}; do
              echo "ğŸ” DEBUG: Backend check iteration $i/4 starting..."
              if curl -f -s http://localhost:8081/api/Medications > /dev/null 2>&1; then
                echo "âœ… Backend API is healthy!"
                break
              fi
              echo "â³ Backend check $i/4..."
              sleep 3
            done || true
            echo "ğŸ” DEBUG: Backend health check loop finished (exit code: $?)"
            
            # ğŸ” Keycloak realm import (im Hintergrund, nicht blockierend)
            echo "ğŸ” DEBUG: About to start Keycloak import..."
            echo "ğŸ” Starting Keycloak realm import in background..."
            (cd ../keycloak-config && nohup bash -c 'sleep 30 && ./import-realm.sh > /tmp/keycloak-import.log 2>&1' &) || true
            echo "ğŸ” DEBUG: Keycloak import command finished (exit code: $?)"
            
            echo "âœ… Deployment completed!"
            echo "ğŸ“‹ Final container status:"
            docker compose ps
            
            echo "ğŸŒ Services available at:"
            echo "  ğŸš€ Backend API: http://vm12.htl-leonding.ac.at:8081"
            echo "  ğŸ“– Swagger UI: http://vm12.htl-leonding.ac.at:8081/swagger/index.html"
            echo "  ğŸ”§ pgAdmin: http://vm12.htl-leonding.ac.at:8080"
            echo "  ğŸ—„ï¸ PostgreSQL: vm12.htl-leonding.ac.at:5434"
            echo "  ğŸ” Keycloak: http://vm12.htl-leonding.ac.at:8180 (realm import in progress)"
          EOF